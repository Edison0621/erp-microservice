# ERP 系统下一个迭代计划 (Iteration 02) - 产品需求文档 (PRD)

## 1. 迭代目标：从“数字化核心”迈向“智能自动化”

经过 Phase 1-3 的建设，系统已具备财务、库存、采购、生产、销售等核心微服务的“手动操作”能力。本迭代（Iteration 02）将参考 **Odoo 18** 的先进理念，重点解决业务流的**自动化**与**决策智能化**。

### 迭代核心关键词：
- **MRP 自动化**：物料需求自动计算与补货。
- **财务智能化**：实时成本核算与发票 OCR 预留。
- **流程自动化**：基于事件的业务规则引擎（Automation Rules）。
- **AI 平台基础**：数据驱动的预测模型基础。

---

## 2. 核心功能模块

### 2.1 智能 MRP (Material Requirements Planning) 2.0
> 参考 Odoo 的 "Reordering Rules" 与 "MTO/MTS" 逻辑。

**FR-MRP-001：自动补货规则 (Reordering Rules)**
- **功能描述**：系统根据库存水位、安全库存、补货周期（Lead Time）自动生成采购申请或预估生产订单。
- **核心逻辑**：
  - `预测可用量 = 在库 - 销售预留 + 在途采购 + 在制生产`。
  - 当 `预测可用量 < 安全库存` 时，触发补货单据（建议值：`补至最大库存量`）。
- **业务价值**：减少库存积压，防止停工待料。

**FR-MRP-002：多层级 BOM 自动展开 (BOM Explode)**
- **功能描述**：成品生产订单下达时，自动根据多级 BOM 计算所有子项半成品的短缺量，并生成联动的半成品工单。

---

### 2.2 财务广度与深度 (Financial Intelligence)
> 参考 Odoo 的 "Real-time Inventory Valuation"。

**FR-FIN-001：实时移动加权平均法库存估值**
- **功能描述**：每一笔收货/出库动作自动更新物料的加权平均成本，并实时投影到财务读模型。
- **业务规则**：
  - 收货：`新成本 = (旧在库总值 + 本次入库总值) / (旧在库数量 + 本次入库数量)`。
  - 出库：按当前加权平均单价计算出库额。

**FR-FIN-002：生产成本归集 (Manufacturing Costing)**
- **功能描述**：自动将生产领料（直接材料）、报工（直接人工）及预设的分摊率（制造费用）实时归集到生产订单。
- **业务价值**：实现生产过程中的 WIP（在制品）实时准确统计。

---

### 2.3 流程自动化引擎 (Automation Hub)
> 参考 Odoo Studio 的 "Automated Actions"。

**FR-AUTO-001：基于事件的自动化规则 (Event-Driven Rules)**
- **功能描述**：允许管理员配置“触发条件 -> 动作”的业务规则。
- **示例场景**：
  - `触发器`：采购订单审批通过。
  - `动作`：自动生成对应的库存预留，并向供应商发送邮件/Webhook。
  - `触发器`：物料库存低于安全水位。
  - `动作`：在 Teams/Slack/邮件中通知采购经理。

---

### 2.4 AI 赋能基础 (AI Readiness)
> 参考 Odoo 18 的预测分析。

**FR-AI-001：需求预测数据接入 (Demand Forecasting Prep)**
- **功能描述**：建立销售历史趋势分析模型基础。
- **技术实现**：利用现有的 Event Sourcing 轨迹，聚合出按天/周/月的销售分布曲线，为后续引入机器学习模型做“智能安全库存建议”打下基础。

---

## 3. 技术架构演进

### 3.1 跨服务 Saga 优化
- 引入更成熟的 **Dapr Workflow** 或 **MassTransit State Machine**，管理从“MRP 触发 -> 自动 PO -> 自动推送”的长事务流程。

### 3.2 读模型增强 (Read-Model Optimization)
- 针对 BI 和报表，在现有 Postgres 基础上引入 **TimescaleDB** (Postgres 扩展)，用于高效处理库存变动流水的时间序列聚合。

---

## 4. 实施路线图 (Implementation Roadmap)

| 阶段 | 核心任务 | 交付物 |
| :--- | :--- | :--- |
| **Stage 1: MRP** | 自动补货引擎逻辑实现 | MRP 建议清单生成 API |
| **Stage 2: Finance** | 移动加权平均成本计算 & WIP 归集 | 成本分析仪表盘 |
| **Stage 3: Auto** | 通用事件订阅与动作触发器架构 | 自动化规则配置界面 |
| **Stage 4: BI** | TimescaleDB 数据聚合 & Aspire Dashboard 增强 | 全链路业务全景视图 |

---

## 5. 验收标准

1. **自动化率**：对于常规物料（MTS 模式），系统能自动生成建议采购单，准确率 > 95%。
2. **时效性**：任何库存变动后，对应的财务估值更新延迟 < 1 秒（Eventual Consistency 窗口）。
3. **灵活性**：用户能通过配置文件或 UI 新增一个“库存不足通知”的自动化规则。

---
**Prepared by**: Antigravity ERP Architect
**Date**: 2026-02-08
